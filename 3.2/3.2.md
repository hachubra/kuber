# Домашнее задание к занятию «Установка Kubernetes»

### Цель задания

Установить кластер K8s.

### Чеклист готовности к домашнему заданию

1. Развёрнутые ВМ с ОС Ubuntu 20.04-lts.


### Инструменты и дополнительные материалы, которые пригодятся для выполнения задания

1. [Инструкция по установке kubeadm](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/).
2. [Документация kubespray](https://kubespray.io/).

-----

### Задание 1. Установить кластер k8s с 1 master node

1. Подготовка работы кластера из 5 нод: 1 мастер и 4 рабочие ноды.
2. В качестве CRI — containerd.
3. Запуск etcd производить на мастере.
4. Способ установки выбрать самостоятельно.


####  Решение 1.

Подготовка ВМ и установка containerd

```bash
alex@ubu04:~/kuber2025/3.2$ ansible-playbook playbook.yaml 
```

```bash

alex@ubu04:~/kuber2025/3.2$ ansible-playbook playbook.yaml 

PLAY [webservers,databases] ***************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ********************************************************************************************************************************************************************************************************************************************
ok: [work-3]
ok: [work-2]
ok: [work-1]
ok: [work-4]
ok: [main]

TASK [githubixx.containerd : Include variables depending on flavor] ***********************************************************************************************************************************************************************************************
ok: [work-1]
ok: [work-2]
ok: [work-3]
ok: [work-4]
ok: [main]

TASK [githubixx.containerd : Create containerd temporary directory] ***********************************************************************************************************************************************************************************************
ok: [work-2]
ok: [work-3]
ok: [main]
ok: [work-1]
ok: [work-4]

TASK [githubixx.containerd : Downloading containerd archive] ******************************************************************************************************************************************************************************************************
ok: [work-3]
ok: [work-2]
ok: [work-1]
ok: [work-4]
ok: [main]

TASK [githubixx.containerd : Unarchive containerd] ****************************************************************************************************************************************************************************************************************
ok: [work-3]
ok: [work-2]
ok: [work-4]
ok: [main]
ok: [work-1]

TASK [githubixx.containerd : Copy containerd binaries to destination directory] ***********************************************************************************************************************************************************************************
ok: [work-3] => (item=ctr)
ok: [work-2] => (item=ctr)
ok: [work-1] => (item=ctr)
ok: [main] => (item=ctr)
ok: [work-4] => (item=ctr)
ok: [work-3] => (item=containerd)
ok: [work-2] => (item=containerd)
ok: [work-4] => (item=containerd)
ok: [work-1] => (item=containerd)
ok: [main] => (item=containerd)
ok: [work-3] => (item=containerd-stress)
ok: [work-2] => (item=containerd-stress)
ok: [work-4] => (item=containerd-stress)
ok: [main] => (item=containerd-stress)
ok: [work-1] => (item=containerd-stress)
ok: [work-3] => (item=containerd-shim-runc-v2)
ok: [work-2] => (item=containerd-shim-runc-v2)
ok: [main] => (item=containerd-shim-runc-v2)
ok: [work-4] => (item=containerd-shim-runc-v2)
ok: [work-1] => (item=containerd-shim-runc-v2)

TASK [githubixx.containerd : Create directory for containerd configuration file] **********************************************************************************************************************************************************************************
ok: [work-1]
ok: [work-2]
ok: [work-3]
ok: [work-4]
ok: [main]

TASK [githubixx.containerd : Create containerd configuration file] ************************************************************************************************************************************************************************************************
ok: [work-2]
ok: [work-3]
ok: [work-1]
ok: [work-4]
ok: [main]

TASK [githubixx.containerd : Find location of modprobe binary] ****************************************************************************************************************************************************************************************************
ok: [work-2] => (item=/usr/bin/modprobe)
ok: [work-3] => (item=/usr/bin/modprobe)
ok: [work-1] => (item=/usr/bin/modprobe)
ok: [main] => (item=/usr/bin/modprobe)
ok: [work-4] => (item=/usr/bin/modprobe)
ok: [work-2] => (item=/usr/sbin/modprobe)
ok: [work-3] => (item=/usr/sbin/modprobe)
ok: [work-1] => (item=/usr/sbin/modprobe)
ok: [work-4] => (item=/usr/sbin/modprobe)
ok: [main] => (item=/usr/sbin/modprobe)
ok: [work-2] => (item=/sbin/modprobe)
ok: [work-3] => (item=/sbin/modprobe)
ok: [work-4] => (item=/sbin/modprobe)
ok: [work-1] => (item=/sbin/modprobe)
ok: [main] => (item=/sbin/modprobe)

TASK [githubixx.containerd : Set modprobe_location] ***************************************************************************************************************************************************************************************************************
ok: [work-1]
ok: [work-2]
ok: [work-3]
ok: [work-4]
ok: [main]

TASK [githubixx.containerd : Modprobe path] ***********************************************************************************************************************************************************************************************************************
ok: [work-1] => {
    "msg": "Using /usr/sbin/modprobe in containerd.service"
}
ok: [work-2] => {
    "msg": "Using /usr/sbin/modprobe in containerd.service"
}
ok: [work-3] => {
    "msg": "Using /usr/sbin/modprobe in containerd.service"
}
ok: [work-4] => {
    "msg": "Using /usr/sbin/modprobe in containerd.service"
}
ok: [main] => {
    "msg": "Using /usr/sbin/modprobe in containerd.service"
}

TASK [githubixx.containerd : Create containerd.service systemd file] **********************************************************************************************************************************************************************************************
ok: [work-2]
ok: [work-1]
ok: [work-3]
ok: [work-4]
ok: [main]

TASK [githubixx.containerd : Flush handlers] **********************************************************************************************************************************************************************************************************************

TASK [githubixx.containerd : Flush handlers] **********************************************************************************************************************************************************************************************************************

TASK [githubixx.containerd : Flush handlers] **********************************************************************************************************************************************************************************************************************

TASK [githubixx.containerd : Flush handlers] **********************************************************************************************************************************************************************************************************************

TASK [githubixx.containerd : Flush handlers] **********************************************************************************************************************************************************************************************************************

TASK [githubixx.containerd : Enable and start containerd] *********************************************************************************************************************************************************************************************************
changed: [work-2]
changed: [work-3]
changed: [work-1]
changed: [work-4]
changed: [main]

PLAY RECAP ********************************************************************************************************************************************************************************************************************************************************
main                       : ok=13   changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
work-1                     : ok=13   changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
work-2                     : ok=13   changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
work-3                     : ok=13   changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
work-4                     : ok=13   changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

Подготовка к установке кластера k8s через kubespray:

```bash
git clone --depth=1 https://github.com/kubernetes-sigs/kubespray.git
```
```bash
alex@ubu04:~/kuber2025/3.2$ git clone --depth=1 https://github.com/kubernetes-sigs/kubespray.git
Cloning into 'kubespray'...
remote: Enumerating objects: 1807, done.
remote: Counting objects: 100% (1807/1807), done.
remote: Compressing objects: 100% (1324/1324), done.
remote: Total 1807 (delta 178), reused 1462 (delta 161), pack-reused 0 (from 0)
Receiving objects: 100% (1807/1807), 2.65 MiB | 4.33 MiB/s, done.
Resolving deltas: 100% (178/178), done.
```
```bash
sudo apt install python3-venv
```

```bash
alex@ubu04:~/kuber2025/3.2$ sudo apt install python3-venv
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following packages were automatically installed and are no longer required:
  python3-bracex python3-enrich python3-pathspec python3-pbr python3-ruamel.yaml python3-ruamel.yaml.clib python3-tenacity python3-wcmatch yamllint
Use 'sudo apt autoremove' to remove them.
The following NEW packages will be installed:
  python3-venv
0 upgraded, 1 newly installed, 0 to remove and 76 not upgraded.
Need to get 1 042 B of archives.
After this operation, 6 144 B of additional disk space will be used.
Get:1 http://archive.ubuntu.com/ubuntu jammy-updates/universe amd64 python3-venv amd64 3.10.6-1~22.04.1 [1 042 B]
Fetched 1 042 B in 0s (3 791 B/s)
Selecting previously unselected package python3-venv.
(Reading database ... 378332 files and directories currently installed.)
Preparing to unpack .../python3-venv_3.10.6-1~22.04.1_amd64.deb ...
Unpacking python3-venv (3.10.6-1~22.04.1) ...
Setting up python3-venv (3.10.6-1~22.04.1) ...
```
```bash
python3 -m venv venv
```
```bash
source venv/bin/activate
```
```bash
alex@ubu04:~/kuber2025/3.2$ source venv/bin/activate
(venv) alex@ubu04:~/kuber2025/3.2$ 
```
```bash
cd kubespray
```
```bash
pip install -U -r requirements.txt
```
```bash
(venv) alex@ubu04:~/kuber2025/3.2/kubespray$ pip install -U -r requirements.txt
Collecting ansible==10.7.0
  Downloading ansible-10.7.0-py3-none-any.whl (51.6 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 51.6/51.6 MB 507.2 kB/s eta 0:00:00
Collecting cryptography==45.0.6
  Downloading cryptography-45.0.6-cp37-abi3-manylinux_2_34_x86_64.whl (4.4 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 4.4/4.4 MB 478.1 kB/s eta 0:00:00
Collecting jmespath==1.0.1
  Downloading jmespath-1.0.1-py3-none-any.whl (20 kB)
Collecting netaddr==1.3.0
  Downloading netaddr-1.3.0-py3-none-any.whl (2.3 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 2.3/2.3 MB 584.5 kB/s eta 0:00:00
Collecting ansible-core~=2.17.7
  Downloading ansible_core-2.17.13-py3-none-any.whl (2.2 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 2.2/2.2 MB 429.9 kB/s eta 0:00:00
Collecting cffi>=1.14
  Using cached cffi-1.17.1-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (446 kB)
Collecting jinja2>=3.0.0
  Downloading jinja2-3.1.6-py3-none-any.whl (134 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 134.9/134.9 KB 586.9 kB/s eta 0:00:00
Collecting PyYAML>=5.1
  Using cached PyYAML-6.0.2-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (751 kB)
Collecting packaging
  Downloading packaging-25.0-py3-none-any.whl (66 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 66.5/66.5 KB 577.7 kB/s eta 0:00:00
Collecting resolvelib<1.1.0,>=0.5.3
  Downloading resolvelib-1.0.1-py2.py3-none-any.whl (17 kB)
Collecting pycparser
  Using cached pycparser-2.22-py3-none-any.whl (117 kB)
Collecting MarkupSafe>=2.0
  Using cached MarkupSafe-3.0.2-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (20 kB)
Installing collected packages: resolvelib, PyYAML, pycparser, packaging, netaddr, MarkupSafe, jmespath, jinja2, cffi, cryptography, ansible-core, ansible

Successfully installed MarkupSafe-3.0.2 PyYAML-6.0.2 ansible-10.7.0 ansible-core-2.17.13 cffi-1.17.1 cryptography-45.0.6 jinja2-3.1.6 jmespath-1.0.1 netaddr-1.3.0 packaging-25.0 pycparser-2.22 resolvelib-1.0.1
(venv) alex@ubu04:~/kuber2025/3.2/kubespray$ 
```
```bash
cp -rpf inventory/sample inventory/mycluster
```
```bash
nano inventory/mycluster/inventory.ini 
```
```yaml
#  GNU nano 6.2                                                                                                     inventory/mycluster/inventory.ini                                                                                                              
#This inventory describe a HA typology with stacked etcd (== same nodes as control plane)
# and 3 worker nodes
# See https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html
# for tips on building your # inventory

# Configure 'ip' variable to bind kubernetes services on a different ip than the default iface
# We should set etcd_member_name for etcd cluster. The node that are not etcd members do not need to set the value,
# or can set the empty string value.
[kube_control_plane]
main ansible_host=89.169.154.44  # ip=10.0.1.13 etcd_member_name=etcd1
# node2 ansible_host=95.54.0.13  # ip=10.3.0.2 etcd_member_name=etcd2
# node3 ansible_host=95.54.0.14  # ip=10.3.0.3 etcd_member_name=etcd3

[etcd:children]
kube_control_plane

[kube_node]
 work-1 ansible_host=89.169.158.24  # ip=10.0.1.36
 work-2 ansible_host=89.169.152.39  # ip=10.0.1.25
 work-3 ansible_host=46.21.244.136  # ip=10.0.1.10
 work-4 ansible_host=46.21.247.227  # ip=10.0.1.16
```
Рапзвертывание кластера в яндексе:

```bash
(venv) alex@ubu04:~/kuber2025/3.2/kubespray$ ansible-playbook -i inventory/mycluster/inventory.ini cluster.yml -b --private-key /home/alex/.ssh/new_key_kuber -u ubuntu
```
```bash

PLAY RECAP **********************************************************************************************************************************************************************************************************************************************************
main                       : ok=545  changed=25   unreachable=0    failed=0    skipped=905  rescued=0    ignored=3   
work-1                     : ok=453  changed=31   unreachable=0    failed=0    skipped=701  rescued=0    ignored=0   
work-2                     : ok=410  changed=13   unreachable=0    failed=0    skipped=620  rescued=0    ignored=0   
work-3                     : ok=410  changed=13   unreachable=0    failed=0    skipped=620  rescued=0    ignored=0   
work-4                     : ok=410  changed=13   unreachable=0    failed=0    skipped=620  rescued=0    ignored=0   

Воскресенье 31 августа 2025  03:41:14 +0500 (0:00:00.433)       0:20:11.970 *** 
=============================================================================== 
container-engine/crictl : Download_file | Download item ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 24.41s
container-engine/nerdctl : Download_file | Download item ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 23.49s
container-engine/runc : Download_file | Download item ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 22.76s
network_plugin/calico : Wait for calico kubeconfig to be created -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 22.67s
container-engine/containerd : Download_file | Download item ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 22.43s
container-engine/crictl : Extract_file | Unpacking archive -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 21.72s
network_plugin/calico : Get current calico version ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 20.31s
download : Download_file | Download item -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 15.99s
container-engine/nerdctl : Extract_file | Unpacking archive ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 15.56s
etcdctl_etcdutl : Download_file | Download item ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 13.39s
network_plugin/cni : CNI | Copy cni plugins ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 12.04s
network_plugin/calico : Get Calico default-pool configuration ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 10.61s
network_plugin/calico : Check if calicoctl.sh exists -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 10.59s
network_plugin/calico : Check if calico ready --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 10.55s
etcdctl_etcdutl : Extract_file | Unpacking archive ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 10.42s
kubernetes-apps/ansible : Kubernetes Apps | CoreDNS --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 10.35s
system_packages : Manage packages ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 8.84s
network_plugin/calico : Calico | Create calico manifests ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 8.65s
network_plugin/calico : Calico | Copy calicoctl binary from download dir ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 8.62s
download : Download | Download files / images ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 8.51s
(venv) alex@ubu04:~/kuber2025/3.2/kubespray$ 
```
```bash
(venv) alex@ubu04:~/kuber2025/3.2/kubespray$ ssh ubuntu@89.169.154.44
```

```bash
ubuntu@main:~$ mkdir -p $HOME/.kube
ubuntu@main:~$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
ubuntu@main:~$ sudo chown $(id -u):$(id -g) $HOME/.kube/config
```
Проверка работы кластера:

```bash
ubuntu@main:~$ kubectl get nodes 
NAME     STATUS   ROLES           AGE   VERSION
main     Ready    control-plane   90m   v1.33.4
work-1   Ready    <none>          10m   v1.33.4
work-2   Ready    <none>          10m   v1.33.4
work-3   Ready    <none>          10m   v1.33.4
work-4   Ready    <none>          10m   v1.33.4
ubuntu@main:~$ 
```
```bash
ubuntu@main:~$ kubectl get po -A
NAMESPACE     NAME                                     READY   STATUS    RESTARTS   AGE
kube-system   calico-kube-controllers-dbf6dc49-j97cz   1/1     Running   0          11m
kube-system   calico-node-c6vht                        1/1     Running   0          12m
kube-system   calico-node-kk676                        1/1     Running   0          12m
kube-system   calico-node-lkwqh                        1/1     Running   0          12m
kube-system   calico-node-nghnp                        1/1     Running   0          12m
kube-system   calico-node-qbv4z                        1/1     Running   0          12m
kube-system   coredns-74697c986-5svg8                  1/1     Running   0          11m
kube-system   coredns-74697c986-qfmbw                  1/1     Running   0          11m
kube-system   dns-autoscaler-56cb45595c-lkt9r          1/1     Running   0          11m
kube-system   kube-apiserver-main                      1/1     Running   1          94m
kube-system   kube-controller-manager-main             1/1     Running   2          94m
kube-system   kube-proxy-6xlm5                         1/1     Running   0          13m
kube-system   kube-proxy-6xzdz                         1/1     Running   0          13m
kube-system   kube-proxy-hfs7g                         1/1     Running   0          13m
kube-system   kube-proxy-ssk5t                         1/1     Running   0          13m
kube-system   kube-proxy-w5qmt                         1/1     Running   0          13m
kube-system   kube-scheduler-main                      1/1     Running   1          94m
kube-system   nginx-proxy-work-1                       1/1     Running   0          14m
kube-system   nginx-proxy-work-2                       1/1     Running   0          14m
kube-system   nginx-proxy-work-3                       1/1     Running   0          14m
kube-system   nginx-proxy-work-4                       1/1     Running   0          14m
kube-system   nodelocaldns-56sx2                       1/1     Running   0          11m
kube-system   nodelocaldns-gptwg                       1/1     Running   0          11m
kube-system   nodelocaldns-nd9kq                       1/1     Running   0          11m
kube-system   nodelocaldns-p2d7s                       1/1     Running   0          11m
kube-system   nodelocaldns-vbdnn                       1/1     Running   0          11m
ubuntu@main:~$ 
```


---

## Дополнительные задания (со звёздочкой)

**Настоятельно рекомендуем выполнять все задания под звёздочкой.** Их выполнение поможет глубже разобраться в материале.   
Задания под звёздочкой необязательные к выполнению и не повлияют на получение зачёта по этому домашнему заданию. 

------
### Задание 2*. Установить HA кластер

1. Установить кластер в режиме HA.
2. Использовать нечётное количество Master-node.
3. Для cluster ip использовать keepalived или другой способ.

### Правила приёма работы

1. Домашняя работа оформляется в своем Git-репозитории в файле README.md. Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.
2. Файл README.md должен содержать скриншоты вывода необходимых команд `kubectl get nodes`, а также скриншоты результатов.
3. Репозиторий должен содержать тексты манифестов или ссылки на них в файле README.md.
