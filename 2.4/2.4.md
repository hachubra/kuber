# Домашнее задание к занятию «Управление доступом»

### Цель задания

В тестовой среде Kubernetes нужно предоставить ограниченный доступ пользователю.

------

### Чеклист готовности к домашнему заданию

1. Установлено k8s-решение, например MicroK8S.
2. Установленный локальный kubectl.
3. Редактор YAML-файлов с подключённым github-репозиторием.

------

### Инструменты / дополнительные материалы, которые пригодятся для выполнения задания

1. [Описание](https://kubernetes.io/docs/reference/access-authn-authz/rbac/) RBAC.
2. [Пользователи и авторизация RBAC в Kubernetes](https://habr.com/ru/company/flant/blog/470503/).
3. [RBAC with Kubernetes in Minikube](https://medium.com/@HoussemDellai/rbac-with-kubernetes-in-minikube-4deed658ea7b).

------

### Задание 1. Создайте конфигурацию для подключения пользователя

1. Создайте и подпишите SSL-сертификат для подключения к кластеру.
2. Настройте конфигурационный файл kubectl для подключения.
3. Создайте роли и все необходимые настройки для пользователя.
4. Предусмотрите права пользователя. Пользователь может просматривать логи подов и их конфигурацию (`kubectl logs pod <pod_id>`, `kubectl describe pod <pod_id>`).
5. Предоставьте манифесты и скриншоты и/или вывод необходимых команд.


#### Решение 1.

Создание закрытого ключа и файла-запроса сертификата:

```bash
alex@ubu04:~/kuber2025/2.4/certs$ openssl genrsa -out netol.key 2048
alex@ubu04:~/kuber2025/2.4/certs$ openssl req -new -key netol.key -out netol.csr -subj "/CN=netol"
```

Выпуск и подписание сертификата корневым сертификатом кластера для созданного файла-запроса:

```bash
alex@ubu04:~/kuber2025/2.4/certs$ openssl x509 -req -in netol.csr -CA /var/snap/microk8s/current/certs/ca.crt -CAkey /var/snap/microk8s/current/certs/ca.key -CAcreateserial -out netol.crt -days 500
Certificate request self-signature ok
subject=CN = netol
```

Перемещение сертификата и ключа в другой каталог:
```bash
alex@ubu04:~/kuber2025/2.4/certs$ mkdir .certs && mv netol.crt netol.key .certs
```

Создание и настройка пользователя в кластере:

```bash
alex@ubu04:~/kuber2025/2.4/certs$ kubectl config set-credentials netol --client-certificate /home/alex/kuber2025/2.4/certs/.certs/netol.crt --client-key /home/alex/kuber2025/2.4/certs/.certs/netol.key --embed-certs=true
User "netol" set.
```

Создание контекста для созданного пользователя:

```bash
alex@ubu04:~/kuber2025/2.4/certs$ kubectl config set-context netol-context --cluster=microk8s-cluster --user=netol
Context "netol-context" created.
```
Перекключение на созданный контекст:
```bash
alex@ubu04:~/kuber2025/2.4/certs$ kubectl config use-context netol-context 
Switched to context "netol-context".
```

Проверка работы (пока без включения RBAC):

```bash
alex@ubu04:~/kuber2025/2.4/certs$ kubectl get po
NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-659bf8db6b-l4hhx   1/1     Running   0          15h
```

Включение RBAC:

```bash
alex@ubu04:~/kuber2025/2.4/certs$ microk8s enable rbac
Infer repository core for addon rbac
Enabling RBAC
Reconfiguring apiserver
[sudo] password for alex: 
Restarting apiserver
RBAC is enabled
```
Проверка работы (после включения RBAC):

```bash
alex@ubu04:~/kuber2025/2.4/certs$ kubectl get po
Error from server (Forbidden): pods is forbidden: User "netol" cannot list resource "pods" in API group "" in the namespace "default"
```
Манифесты Role и RoleBinding:

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: netol-role
  namespace: default
rules:
- apiGroups: [""]
  resources: ["pods", "pods/log"]
  verbs: ["get", "watch", "list"]
```

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: netol-role
  namespace: default
subjects:
- kind: User
  name: netol
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: netol-role
  apiGroup: rbac.authorization.k8s.io
```

Применение манифестов:

```bash
alex@ubu04:~/kuber2025/2.4$ kubectl apply -f role.yaml 
role.rbac.authorization.k8s.io/netol-role created
alex@ubu04:~/kuber2025/2.4$ kubectl apply -f role-binding.yaml 
rolebinding.rbac.authorization.k8s.io/netol-role created
```

Переключение в контекст и проверка работы:

```bash
alex@ubu04:~/kuber2025/2.4$ kubectl config use-context netol-context 
Switched to context "netol-context".
```

```bash
alex@ubu04:~/kuber2025/2.4$ kubectl get po
NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-659bf8db6b-l4hhx   1/1     Running   0          16h
alex@ubu04:~/kuber2025/2.4$ kubectl logs pods/nginx-deployment-659bf8db6b-l4hhx 
/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
/docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/
/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh
10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf
10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf
/docker-entrypoint.sh: Sourcing /docker-entrypoint.d/15-local-resolvers.envsh
/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh
/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh
/docker-entrypoint.sh: Configuration complete; ready for start up
10.1.140.90 - - [16/Aug/2025:19:08:26 +0000] "GET / HTTP/1.1" 200 222 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:141.0) Gecko/20100101 Firefox/141.0"
2025/08/16 19:08:26 [error] 31#31: *1 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 10.1.140.90, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "ubu04.local", referrer: "https://ubu04.local/"
10.1.140.90 - - [16/Aug/2025:19:08:26 +0000] "GET /favicon.ico HTTP/1.1" 404 153 "https://ubu04.local/" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:141.0) Gecko/20100101 Firefox/141.0"
10.1.140.90 - - [16/Aug/2025:19:11:40 +0000] "GET / HTTP/1.1" 304 0 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:141.0) Gecko/20100101 Firefox/141.0"
10.1.140.90 - - [16/Aug/2025:19:11:41 +0000] "GET / HTTP/1.1" 304 0 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:141.0) Gecko/20100101 Firefox/141.0"
10.1.140.90 - - [16/Aug/2025:19:14:34 +0000] "GET / HTTP/1.1" 200 222 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:141.0) Gecko/20100101 Firefox/141.0"
10.1.140.90 - - [16/Aug/2025:19:16:15 +0000] "GET / HTTP/1.1" 200 222 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:141.0) Gecko/20100101 Firefox/141.0"
10.1.140.90 - - [16/Aug/2025:19:16:16 +0000] "GET / HTTP/1.1" 304 0 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:141.0) Gecko/20100101 Firefox/141.0"
10.1.140.90 - - [16/Aug/2025:19:17:25 +0000] "GET / HTTP/1.1" 304 0 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:141.0) Gecko/20100101 Firefox/141.0"
10.1.140.90 - - [16/Aug/2025:19:17:27 +0000] "GET / HTTP/1.1" 304 0 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:141.0) Gecko/20100101 Firefox/141.0"
10.1.140.90 - - [16/Aug/2025:19:34:44 +0000] "GET / HTTP/1.1" 304 0 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:141.0) Gecko/20100101 Firefox/141.0"
10.1.140.90 - - [16/Aug/2025:19:34:45 +0000] "GET / HTTP/1.1" 304 0 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:141.0) Gecko/20100101 Firefox/141.0"
10.1.140.90 - - [16/Aug/2025:19:42:10 +0000] "GET / HTTP/1.1" 304 0 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:141.0) Gecko/20100101 Firefox/141.0"
10.1.140.90 - - [16/Aug/2025:19:51:24 +0000] "GET / HTTP/1.1" 304 0 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:141.0) Gecko/20100101 Firefox/141.0"
2025/08/16 19:51:25 [error] 31#31: *8 open() "/usr/share/nginx/html/favicon.ico" failed (2: No such file or directory), client: 10.1.140.90, server: localhost, request: "GET /favicon.ico HTTP/1.1", host: "ubu04.local", referrer: "https://ubu04.local/"
10.1.140.90 - - [16/Aug/2025:19:51:25 +0000] "GET /favicon.ico HTTP/1.1" 404 153 "https://ubu04.local/" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:141.0) Gecko/20100101 Firefox/141.0"
alex@ubu04:~/kuber2025/2.4$ 
```

Другие команды не выполняются: 

```bash
alex@ubu04:~/kuber2025/2.4$ kubectl get nodes
Error from server (Forbidden): nodes is forbidden: User "netol" cannot list resource "nodes" in API group "" at the cluster scope
```


------

### Правила приёма работы

1. Домашняя работа оформляется в своём Git-репозитории в файле README.md. Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.
2. Файл README.md должен содержать скриншоты вывода необходимых команд `kubectl`, скриншоты результатов.
3. Репозиторий должен содержать тексты манифестов или ссылки на них в файле README.md.

------

